#cloud-config
package_update: true
package_upgrade: true

packages:
  - nginx
  - php8.1-fpm
  - php8.1-mysql
  - php8.1-mbstring
  - php8.1-xml
  - php8.1-curl
  - php8.1-zip
  - php8.1-gd
  - git
  - ufw

###############################################################################
# 1.  Environment variables for the PHP code
###############################################################################
write_files:
  - path: /etc/environment
    append: true
    content: |
      DB_HOST=${db_host}
      DB_PORT=${db_port}
      DB_USER=${db_user}
      DB_PASSWORD=${db_password}
      DB_NAME=axialy_admin

      UI_DB_HOST=${db_host}
      UI_DB_PORT=${db_port}
      UI_DB_USER=${db_user}
      UI_DB_PASSWORD=${db_password}
      UI_DB_NAME=axialy_ui

      ADMIN_DEFAULT_USER=${admin_default_user}
      ADMIN_DEFAULT_EMAIL=${admin_default_email}
      ADMIN_DEFAULT_PASSWORD=${admin_default_password}

  # ── nginx vhost (NO duplicate fastcgi_pass!) ──────────────────────────────
  - path: /etc/nginx/sites-available/axialy-admin.conf
    permissions: "0644"
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          server_name _;
          root /var/www/axialy-admin;

          index index.php;
          client_max_body_size 16M;

          location / {
              try_files $uri $uri/ /index.php?$query_string;
          }

          location ~ \.php$ {
              include               fastcgi_params;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_pass          unix:/var/run/php/php8.1-fpm.sock;
          }

          location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
              expires 30d;
              access_log off;
          }
      }

###############################################################################
# 2.  One-shot bootstrap commands
###############################################################################
runcmd:
  # 2-1  firewall
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable

  # 2-2  PHP hardening
  - sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/' /etc/php/8.1/fpm/php.ini

  # 2-3  session dir perms
  - chown root:www-data /var/lib/php/sessions
  - chmod 1730          /var/lib/php/sessions

  # 2-4  enable & start services
  - systemctl enable php8.1-fpm
  - systemctl enable nginx
  - systemctl restart php8.1-fpm
  - systemctl restart nginx

  # 2-5  web root pre-create (deploy.sh drops code later)
  - mkdir -p /var/www/axialy-admin
  - chown -R www-data:www-data /var/www/axialy-admin
  - find /var/www/axialy-admin -type d -exec chmod 755 {} \;

  # 2-6  activate vhost & verify
  - ln -sf /etc/nginx/sites-available/axialy-admin.conf /etc/nginx/sites-enabled/axialy-admin.conf
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t
  - systemctl reload nginx
