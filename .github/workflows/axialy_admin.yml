name: Axialy Admin Droplet

on:
  workflow_dispatch:
    inputs:
      droplet_name:
        description: "Droplet hostname"
        required: true
      region:
        description: "DO region"
        default: sfo3
      size:
        description: "Droplet size"
        default: s-1vcpu-2gb

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # ─── DigitalOcean creds ─────────────────────────────────────────
      TF_VAR_do_token:        ${{ secrets.DIGITALOCEAN_TOKEN }}
      TF_VAR_ssh_fingerprint: ${{ secrets.DO_SSH_FINGERPRINT }}   # ← **REQUIRED**
      # (keep the public-key var if other modules/scripts still need it)
      TF_VAR_ssh_public_key:  ${{ secrets.DO_SSH_PUBLIC_KEY }}

      # ─── Repo URL passed to cloud-init ──────────────────────────────
      TF_VAR_repo_url:        ${{ github.server_url }}/${{ github.repository }}.git

      # ─── DB credentials (written by axialy_db.yml) ─────────────────
      TF_VAR_db_host:         ${{ secrets.DB_HOST }}
      TF_VAR_db_port:         ${{ secrets.DB_PORT }}
      TF_VAR_db_user:         ${{ secrets.DB_USER }}
      TF_VAR_db_pass:         ${{ secrets.DB_PASSWORD }}

      # ─── First-use admin account for Axialy Admin UI ───────────────
      TF_VAR_admin_default_user:      ${{ secrets.ADMIN_DEFAULT_USER }}
      TF_VAR_admin_default_email:     ${{ secrets.ADMIN_DEFAULT_EMAIL }}
      TF_VAR_admin_default_password:  ${{ secrets.ADMIN_DEFAULT_PASSWORD }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform init
        working-directory: infra/droplet
        run: terraform init -input=false

      - name: Terraform apply
        working-directory: infra/droplet
        run: |
          terraform apply -auto-approve \
            -var="droplet_name=${{ github.event.inputs.droplet_name }}" \
            -var="region=${{ github.event.inputs.region }}" \
            -var="size=${{ github.event.inputs.size }}"

      - name: Show public IP
        working-directory: infra/droplet
        run: |
          echo "Axialy Admin is booting…"
          terraform output droplet_ip
