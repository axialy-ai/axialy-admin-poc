# =====================================================================
#  Axialy Admin Droplet
#  -------------------------------------------------------------------
#  • Builds / provisions the Ubuntu droplet that runs the Admin PHP app
#  • Pulls eight DB-secrets written by the “Axialy DB” workflow
#  • Passes **both** credential sets (ADMIN + UI) to Terraform
# =====================================================================

name: Axialy Admin Droplet

on:
  workflow_dispatch:
    inputs:
      droplet_name:
        description: "Droplet hostname"
        required: true
      region:
        description: "DigitalOcean region (e.g. nyc3, sfo3, fra1…)"
        default: nyc3
      size:
        description: "Droplet size slug"
        default: s-1vcpu-2gb

jobs:
  deploy:
    runs-on: ubuntu-latest

    # -----------------------------------------------------------------
    #  Environment variables ⇢ become TF_VAR_* and app-bootstrap values
    # -----------------------------------------------------------------
    env:
      # DigitalOcean + repo
      TF_VAR_do_token:            ${{ secrets.DIGITALOCEAN_TOKEN }}
      TF_VAR_ssh_fingerprint:     ${{ secrets.SSH_FINGERPRINT }}
      TF_VAR_repo_url:            ${{ github.server_url }}/${{ github.repository }}.git

      # ---------- shared cluster endpoint ----------
      TF_VAR_db_host:             ${{ secrets.DB_HOST }}
      TF_VAR_db_port:             ${{ secrets.DB_PORT }}

      # ---------- Axialy_ADMIN credentials ----------
      TF_VAR_admin_db_name:       ${{ secrets.ADMIN_DB_NAME }}
      TF_VAR_admin_db_user:       ${{ secrets.ADMIN_DB_USER }}
      TF_VAR_admin_db_pass:       ${{ secrets.ADMIN_DB_PASS }}

      # ---------- Axialy_UI credentials -------------
      TF_VAR_ui_db_name:          ${{ secrets.UI_DB_NAME }}
      TF_VAR_ui_db_user:          ${{ secrets.UI_DB_USER }}
      TF_VAR_ui_db_pass:          ${{ secrets.UI_DB_PASS }}

      # ---------- first-login bootstrap -------------
      TF_VAR_admin_default_user:      ${{ secrets.ADMIN_DEFAULT_USER }}
      TF_VAR_admin_default_email:     ${{ secrets.ADMIN_DEFAULT_EMAIL }}
      TF_VAR_admin_default_password:  ${{ secrets.ADMIN_DEFAULT_PASSWORD }}

    # -----------------------------------------------------------------
    #  Steps
    # -----------------------------------------------------------------
    steps:
      - uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform init
        working-directory: infra/droplet
        run: terraform init -input=false

      - name: Terraform apply (create / update droplet)
        working-directory: infra/droplet
        run: |
          terraform apply -auto-approve \
            -var="droplet_name=${{ github.event.inputs.droplet_name }}" \
            -var="region=${{ github.event.inputs.region }}" \
            -var="size=${{ github.event.inputs.size }}"

      - name: Show public IP
        working-directory: infra/droplet
        run: |
          echo 'Axialy Admin droplet is booting…'
          terraform output droplet_ip
